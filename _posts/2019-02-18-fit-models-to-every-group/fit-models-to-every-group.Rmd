---
title: "Fit the same statistical model to many groups with one simple line of code"
description: |
  How to use data.table package to fit a model to different groups in a dataset using only one line of code
author:
  - name: Hause Lin
date: 02-18-2019
output:
  radix::radix_article:
    toc: true
    self_contained: false
draft: false
categories: 
  - data.table
repository_url: https://github.com/hauselin/rtutorialsite/blob/master/_posts/2019-02-18-fit-models-to-every-group/fit-models-to-every-group.Rmd
---

```{r setup, include=FALSE}
library(roxygen2)
knitr::opts_chunk$set(echo = TRUE,
                      R.options = list(width = 80),
                      tidy = TRUE,
                      tidy.opts = list(width.cutoff = 80))
```

Get source code for this RMarkdown script [here](https://github.com/hauselin/rtutorialsite/blob/master/_posts/2019-02-18-fit-models-to-every-group/fit-models-to-every-group.Rmd).

## How to use `data.table` package to fit a model to different groups in a dataset.

```{r}
# load packages
library(hausekeep); library(data.table)
```

Convert the built-in dataset `ChickWeight` to `data.table` class so we can leverage its extensive functionalities. 

```{r} 
dt1 <- data.table(ChickWeight) # convert builtin dataset to data.table class
dt1 # print dataset 
```

<aside>
Dataset contains weights of 50 chicks that were fed one of four diets. Their weights were tracked over time. Type `?ChickWeight` in the console for more info about this dataset.
</aside>

Let's look at just the first 5 chicks (and to illustrate `data.table` syntax; see my [data.table](https://hausetutorials.netlify.com/0002_tidyverse_datatable.html) tutorials). We then fit a linear regression `weight ~ Time` to the data from these 5 chicks, ignoring that the data came from 5 different chicks. 

```{r}
# filter rows where Chick is <= 5 and fit linear regression model
dt1[Chick <= 5, ] # syntax works only with data.table
model <- lm(weight ~ Time, data = dt1[Chick <= 5])
summary(model)
```

<aside>
The correct way to fit this model is to account for the nested structure is to use linear mixed models (lme4 package): `lmer(weight ~ Time + (1 | Chick), data = dt1[Chick <= 5])`
</aside>

Show formatted output that can be copied-pasted into your APA manuscript.

```{r}
summaryh(model) 
```

Fit the same model within `data.table`

```{r}
dt1[Chick <= 5, summaryh(lm(weight ~ Time))] # results are same as above
```

<aside>
`summaryh()` returns results in a `data.table`.
</aside>

What if you want to fit a separate model for each chick/group, so you know how time was associated with weight for each chick? You could write a for loop to loop through each chick, but you can do it with `data.table` syntax really easily. 

Now we can extend the syntax above with `by = Chick` to fit the model to each chick! Just one line of code is needed.

```{r}
# fit linear regression model to first 5 Chicks
dt1[Chick %in% 1:5, summaryh(lm(weight ~ Time)), by = Chick]
```
<aside>
When calling functions inside a `data.table` with the `by` argument, your functions have to return vectors, lists, or dataframes. Otherwise, you'll get error messages. Run the code below to figure out why.
</aside>

Why won't `summary()` work?

```{r
dt1[Chick <= 5, summary(lm(weight ~ Time))] # summary() doesn't return a table
dt1[Chick <= 5, summary(lm(weight ~ Time)), by = Chick] # doesn't work! 
```


